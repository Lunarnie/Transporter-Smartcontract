<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Quản lý Vận chuyển</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .login-section {
            max-width: 500px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .account-info {
            display: none;
            align-items: center;
            justify-content: space-between;
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            color: white;
            margin-bottom: 20px;
        }

        .account-details {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .dashboard-content {
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .stat-card p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .orders-table th,
        .orders-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }

        .orders-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        .orders-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-preparing {
            background: #cce5ff;
            color: #004085;
        }

        .status-pickup {
            background: #e2e3ff;
            color: #383d41;
        }

        .status-delivering {
            background: #b3d9ff;
            color: #004085;
        }

        .status-delivered {
            background: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .order-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .order-actions .btn {
            padding: 8px 15px;
            font-size: 14px;
            margin: 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e1e5e9;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 8px;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }

        .alert-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }

        .order-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #e1e5e9;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: #555;
        }

        .detail-value {
            color: #333;
        }

        .connection-mode {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }

        .connection-mode h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .mode-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
        }

        .mode-btn:hover {
            background: #667eea;
            color: white;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .orders-table {
                font-size: 14px;
            }

            .orders-table th,
            .orders-table td {
                padding: 10px 8px;
            }

            .order-actions {
                flex-direction: column;
            }

            .order-actions .btn {
                width: 100%;
                margin-bottom: 5px;
            }

            .mode-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚚 Hệ thống Quản lý Vận chuyển</h1>
            <p>Quản lý đơn hàng và dịch vụ vận chuyển</p>
        </div>

        <!-- Account Info -->
        <div class="account-info" id="accountInfo">
            <div class="account-details">
                <div>
                    <strong>🏠 Địa chỉ ví:</strong>
                    <span id="walletAddress">Chưa kết nối</span>
                </div>
                <div>
                    <strong>📄 Contract:</strong>
                    <span id="currentContract">Chưa thiết lập</span>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="logout()">Đăng xuất</button>
        </div>

        <!-- Login Section -->
        <div class="login-section" id="loginSection">
            <div class="card">
                <h2 style="text-align: center; margin-bottom: 25px; color: #333;">🔐 Đăng nhập Transporter</h2>
                
                <!-- Connection Mode Selection -->
                <div class="connection-mode">
                    <h4>🔌 Chọn phương thức kết nối</h4>
                    <div class="mode-buttons">
                        <button class="mode-btn active" onclick="selectMode('private')">🔑 Private Key</button>
                        <button class="mode-btn" onclick="selectMode('metamask')">🦊 MetaMask</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="rpcUrl">🌐 RPC URL</label>
                    <input type="text" id="rpcUrl" class="form-control" placeholder="http://localhost:8545" value="http://localhost:8545">
                </div>

                <div class="form-group">
                    <label for="contractAddress">📄 Địa chỉ Contract</label>
                    <input type="text" id="contractAddress" class="form-control" placeholder="0x...">
                </div>

                <div class="form-group" id="privateKeyGroup">
                    <label for="privateKey">🔑 Private Key</label>
                    <input type="password" id="privateKey" class="form-control" placeholder="0x...">
                </div>

                <button class="btn" onclick="connectWallet()" style="width: 100%;">
                    <span id="connectButtonText">🚀 Kết nối ví</span>
                </button>

                <div id="walletStatus" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div class="dashboard-content" id="dashboardContent">
            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalOrders">0</h3>
                    <p>📦 Tổng đơn hàng</p>
                </div>
                <div class="stat-card">
                    <h3 id="activeOrders">0</h3>
                    <p>🚛 Đang vận chuyển</p>
                </div>
                <div class="stat-card">
                    <h3 id="completedOrders">0</h3>
                    <p>✅ Đã hoàn thành</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalEarnings">0</h3>
                    <p>💰 Tổng thu nhập (Wei)</p>
                </div>
            </div>

            <!-- Orders Table -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>📦 Quản lý đơn hàng</h3>
                    <div>
                        <button class="btn" onclick="loadAllOrders()">🔄 Làm mới</button>
                        <button class="btn btn-success" onclick="loadAvailableOrders()">🆕 Tìm đơn hàng mới</button>
                    </div>
                </div>
                
                <div id="ordersContainer">
                    <div class="loading">Đang tải đơn hàng...</div>
                </div>
            </div>
        </div>

        <!-- Pricing Modal -->
        <div class="modal" id="pricingModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>💰 Đề xuất giá vận chuyển</h3>
                    <button class="close-btn" onclick="closeModal('pricingModal')">&times;</button>
                </div>

                <div class="order-details" id="pricingOrderDetails">
                    <!-- Order details will be populated here -->
                </div>

                <div class="form-group">
                    <label for="suggestedPrice">💵 Giá đề xuất (Wei)</label>
                    <input type="number" id="suggestedPrice" class="form-control" placeholder="Nhập giá vận chuyển" min="1">
                </div>

                <div class="form-group">
                    <label for="pricingNote">📝 Ghi chú</label>
                    <textarea id="pricingNote" class="form-control" rows="3" placeholder="Ghi chú về dịch vụ vận chuyển..."></textarea>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="closeModal('pricingModal')">Hủy</button>
                    <button class="btn" onclick="submitPricing()">📤 Gửi báo giá</button>
                </div>
            </div>
        </div>

        <!-- Status Update Modal -->
        <div class="modal" id="statusModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>📝 Cập nhật trạng thái đơn hàng</h3>
                    <button class="close-btn" onclick="closeModal('statusModal')">&times;</button>
                </div>
                
                <div class="order-details" id="statusOrderDetails">
                    <!-- Order details will be populated here -->
                </div>

                <div class="form-group">
                    <label for="newStatus">Trạng thái mới</label>
                    <select id="newStatus" class="form-control">
                        <option value="3">🚛 Đang giao hàng</option>
                        <option value="4">✅ Đã giao hàng</option>
                    </select>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="closeModal('statusModal')">Hủy</button>
                    <button class="btn" onclick="updateOrderStatus()">💾 Cập nhật</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Contract ABI - Simplified version focusing on essential functions
        const contractABI = [
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			}
		],
		"name": "DeliveryConfirmed",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "enum SupplyChainSystem.DeliveryStage",
				"name": "stage",
				"type": "uint8"
			}
		],
		"name": "DeliveryUpdated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "ManagerAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "ManagerRemoved",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "supplier",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "transporter",
				"type": "address"
			}
		],
		"name": "OrderApproved",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "customer",
				"type": "address"
			}
		],
		"name": "OrderPlaced",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "supplier",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "unitPrice",
				"type": "uint256"
			}
		],
		"name": "ProductAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			}
		],
		"name": "Refunded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "target",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint8",
				"name": "rating",
				"type": "uint8"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "comment",
				"type": "string"
			}
		],
		"name": "ReviewSubmitted",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "TransporterAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "TransporterRemoved",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			}
		],
		"name": "acceptQuotation",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "addManager",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "unitPrice",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "stock",
				"type": "uint256"
			}
		],
		"name": "addProduct",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "addTransporter",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "unitPrice",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "transporter",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "transportFee",
				"type": "uint256"
			}
		],
		"name": "approveOrder",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			}
		],
		"name": "cancelOrder",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			}
		],
		"name": "confirmReceipt",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "customerToRequests",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "deliveries",
		"outputs": [
			{
				"internalType": "address",
				"name": "transporter",
				"type": "address"
			},
			{
				"internalType": "enum SupplyChainSystem.DeliveryStage",
				"name": "stage",
				"type": "uint8"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getAllProducts",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "name",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "unitPrice",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "stock",
						"type": "uint256"
					}
				],
				"internalType": "struct SupplyChainSystem.Product[]",
				"name": "",
				"type": "tuple[]"
			},
			{
				"internalType": "address[]",
				"name": "",
				"type": "address[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getAllRequests",
		"outputs": [
			{
				"components": [
					{
						"internalType": "uint256",
						"name": "id",
						"type": "uint256"
					},
					{
						"internalType": "address",
						"name": "customer",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "supplier",
						"type": "address"
					},
					{
						"internalType": "string",
						"name": "productName",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "quantity",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "maxUnitPrice",
						"type": "uint256"
					},
					{
						"internalType": "string",
						"name": "deliveryAddress",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "timestamp",
						"type": "uint256"
					},
					{
						"internalType": "enum SupplyChainSystem.RequestStatus",
						"name": "status",
						"type": "uint8"
					}
				],
				"internalType": "struct SupplyChainSystem.PurchaseRequest[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "customer",
				"type": "address"
			}
		],
		"name": "getCustomerRequests",
		"outputs": [
			{
				"internalType": "uint256[]",
				"name": "",
				"type": "uint256[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			}
		],
		"name": "getDelivery",
		"outputs": [
			{
				"components": [
					{
						"internalType": "address",
						"name": "transporter",
						"type": "address"
					},
					{
						"internalType": "enum SupplyChainSystem.DeliveryStage",
						"name": "stage",
						"type": "uint8"
					}
				],
				"internalType": "struct SupplyChainSystem.DeliveryInfo",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			}
		],
		"name": "getPayment",
		"outputs": [
			{
				"components": [
					{
						"internalType": "address",
						"name": "customer",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "supplier",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "transporter",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "supplierAmount",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "transportFee",
						"type": "uint256"
					},
					{
						"internalType": "bool",
						"name": "settled",
						"type": "bool"
					},
					{
						"internalType": "bool",
						"name": "refunded",
						"type": "bool"
					}
				],
				"internalType": "struct SupplyChainSystem.Payment",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "supplier",
				"type": "address"
			}
		],
		"name": "getSupplierProducts",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "name",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "unitPrice",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "stock",
						"type": "uint256"
					}
				],
				"internalType": "struct SupplyChainSystem.Product[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "supplier",
				"type": "address"
			}
		],
		"name": "getSupplierReviews",
		"outputs": [
			{
				"components": [
					{
						"internalType": "uint8",
						"name": "rating",
						"type": "uint8"
					},
					{
						"internalType": "string",
						"name": "comment",
						"type": "string"
					}
				],
				"internalType": "struct SupplyChainSystem.Review[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "transporter",
				"type": "address"
			}
		],
		"name": "getTransporterReviews",
		"outputs": [
			{
				"components": [
					{
						"internalType": "uint8",
						"name": "rating",
						"type": "uint8"
					},
					{
						"internalType": "string",
						"name": "comment",
						"type": "string"
					}
				],
				"internalType": "struct SupplyChainSystem.Review[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "isManager",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "isTransporter",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			},
			{
				"internalType": "uint8",
				"name": "rating",
				"type": "uint8"
			},
			{
				"internalType": "string",
				"name": "comment",
				"type": "string"
			}
		],
		"name": "leaveReview",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "offeredPrices",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "payments",
		"outputs": [
			{
				"internalType": "address",
				"name": "customer",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "supplier",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "transporter",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "supplierAmount",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "transportFee",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "settled",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "refunded",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "supplier",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "productName",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "quantity",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "maxUnitPrice",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "deliveryAddress",
				"type": "string"
			}
		],
		"name": "placeOrder",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			}
		],
		"name": "processRefund",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "removeManager",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "removeTransporter",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "requests",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "customer",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "supplier",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "productName",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "quantity",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "maxUnitPrice",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "deliveryAddress",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			},
			{
				"internalType": "enum SupplyChainSystem.RequestStatus",
				"name": "status",
				"type": "uint8"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "unitPrice",
				"type": "uint256"
			}
		],
		"name": "sendQuotation",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "supplierProducts",
		"outputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "unitPrice",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "stock",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "supplierReviews",
		"outputs": [
			{
				"internalType": "uint8",
				"name": "rating",
				"type": "uint8"
			},
			{
				"internalType": "string",
				"name": "comment",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "suppliers",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "transporterReviews",
		"outputs": [
			{
				"internalType": "uint8",
				"name": "rating",
				"type": "uint8"
			},
			{
				"internalType": "string",
				"name": "comment",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			},
			{
				"internalType": "enum SupplyChainSystem.DeliveryStage",
				"name": "stage",
				"type": "uint8"
			}
		],
		"name": "updateDeliveryStage",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	}
];

        // Global variables
        let provider = null;
        let signer = null;
        let contract = null;
        let userAddress = '';
        let allOrders = [];
        let currentOrderId = null;
        let connectionMode = 'private'; // 'private' or 'metamask'

        // Status mappings
        const statusMap = {
            0: { text: 'Chờ xử lý', class: 'status-pending' },
            1: { text: 'Đã báo giá', class: 'status-preparing' },
            2: { text: 'Đã chấp nhận', class: 'status-pickup' },
            3: { text: 'Đang giao hàng', class: 'status-delivering' },
            4: { text: 'Đã giao hàng', class: 'status-delivered' },
            5: { text: 'Đã hủy', class: 'status-cancelled' }
        };

        // Utility functions
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('walletStatus');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + ' Wei';
        }

        function truncateAddress(address) {
            if (!address) return '';
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        }

        function getStatusText(status) {
            return statusMap[status]?.text || 'Không rõ';
        }

        function getStatusClass(status) {
            return statusMap[status]?.class || 'status-pending';
        }

        // Select connection mode
        function selectMode(mode) {
            connectionMode = mode;
            
            // Update UI
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const privateKeyGroup = document.getElementById('privateKeyGroup');
            const connectButtonText = document.getElementById('connectButtonText');
            
            if (mode === 'metamask') {
                privateKeyGroup.style.display = 'none';
                connectButtonText.textContent = '🦊 Kết nối MetaMask';
            } else {
                privateKeyGroup.style.display = 'block';
                connectButtonText.textContent = '🚀 Kết nối ví';
            }
        }

        // Connect wallet function
        async function connectWallet() {
            try {
                const rpcUrl = document.getElementById('rpcUrl').value;
                const contractAddress = document.getElementById('contractAddress').value;

                if (!rpcUrl || !contractAddress) {
                    showStatus('Vui lòng điền đầy đủ RPC URL và địa chỉ Contract!', 'error');
                    return;
                }

                showStatus('⏳ Đang kết nối...', 'info');

                if (connectionMode === 'metamask') {
                    // Connect with MetaMask
                    if (typeof window.ethereum === 'undefined') {
                        showStatus('❌ Vui lòng cài đặt MetaMask!', 'error');
                        return;
                    }

                    // Request account access
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    
                    // Create provider and signer
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                    userAddress = await signer.getAddress();

                } else {
                    // Connect with private key
                    const privateKey = document.getElementById('privateKey').value;
                    
                    if (!privateKey) {
                        showStatus('Vui lòng nhập Private Key!', 'error');
                        return;
                    }

                    // Connect to provider
                    provider = new ethers.JsonRpcProvider(rpcUrl);
                    
                    // Create wallet from private key
                    signer = new ethers.Wallet(privateKey, provider);
                    userAddress = await signer.getAddress();
                }
                
                // Create contract instance
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                
                // Check balance
                const balance = await provider.getBalance(userAddress);
                
                // Update UI
                document.getElementById('walletAddress').textContent = truncateAddress(userAddress);
                document.getElementById('currentContract').textContent = truncateAddress(contractAddress);
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                document.getElementById('accountInfo').style.display = 'flex';
                
                showStatus(`✅ Kết nối thành công!<br>
                           📍 Địa chỉ: ${userAddress}<br>
                           💰 Số dư: ${ethers.formatEther(balance)} ETH`, 'success');
                
                // Load initial data
                await loadAllOrders();
                
            } catch (error) {
                console.error('Lỗi kết nối:', error);
                showStatus(`❌ Lỗi kết nối: ${error.message}`, 'error');
            }
        }

        // Logout function
        function logout() {
            provider = null;
            signer = null;
            contract = null;
            userAddress = '';
            allOrders = [];
            
            // Clear inputs
            if (connectionMode === 'private') {
                document.getElementById('privateKey').value = '';
            }
            
            // Update UI
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('dashboardContent').style.display = 'none';
            document.getElementById('accountInfo').style.display = 'none';
            
            showStatus('✅ Đã đăng xuất thành công', 'success');
        }

       // Load all orders
async function loadAllOrders() {
    if (!contract) return;

    try {
        document.getElementById('ordersContainer').innerHTML = '<div class="loading">Đang tải đơn hàng...</div>';

        // Sử dụng getAllRequests() thay vì requestCounter()
        const allRequests = await contract.getAllRequests();
        allOrders = [];

        for (let order of allRequests) {
            // Lấy thông tin delivery và payment riêng biệt
            const deliveryInfo = await contract.getDelivery(order.id);
            const paymentInfo = await contract.getPayment(order.id);

            allOrders.push({
                id: Number(order.id),
                customer: order.customer,
                supplier: order.supplier,
                productName: order.productName,
                quantity: Number(order.quantity),
                maxUnitPrice: Number(order.maxUnitPrice),
                deliveryAddress: order.deliveryAddress,
                status: Number(order.status),
                timestamp: Number(order.timestamp),
                // Thông tin từ delivery
                transporter: deliveryInfo.transporter,
                deliveryStage: Number(deliveryInfo.stage),
                // Thông tin từ payment
                supplierAmount: Number(paymentInfo.supplierAmount),
                transportFee: Number(paymentInfo.transportFee),
                settled: paymentInfo.settled,
                refunded: paymentInfo.refunded
            });
        }

        displayAllOrders();
        updateDashboard();

    } catch (error) {
        console.error('Lỗi tải đơn hàng:', error);
        document.getElementById('ordersContainer').innerHTML = `
            <div class="alert alert-danger">
                ❌ Lỗi tải đơn hàng: ${error.message}
            </div>
        `;
    }
}

// Load only available orders
async function loadAvailableOrders() {
    if (!contract) return;

    try {
        document.getElementById('ordersContainer').innerHTML = '<div class="loading">Đang tải đơn hàng có sẵn...</div>';

        // Sử dụng getAllRequests() thay vì requestCounter()
        const allRequests = await contract.getAllRequests();
        const availableOrders = [];

        for (let order of allRequests) {
            const deliveryInfo = await contract.getDelivery(order.id);
            
            // Chỉ hiển thị đơn hàng chưa có transporter hoặc đang chờ báo giá
            if (Number(order.status) === 0 && 
                (deliveryInfo.transporter === '0x0000000000000000000000000000000000000000' || 
                 deliveryInfo.transporter.toLowerCase() === userAddress.toLowerCase())) {
                
                const paymentInfo = await contract.getPayment(order.id);
                
                availableOrders.push({
                    id: Number(order.id),
                    customer: order.customer,
                    supplier: order.supplier,
                    productName: order.productName,
                    quantity: Number(order.quantity),
                    maxUnitPrice: Number(order.maxUnitPrice),
                    deliveryAddress: order.deliveryAddress,
                    status: Number(order.status),
                    transporter: deliveryInfo.transporter,
                    shippingFee: Number(paymentInfo.transportFee)
                });
            }
        }

        displayOrders(availableOrders, 'available');

    } catch (error) {
        console.error('Lỗi tải đơn hàng có sẵn:', error);
        document.getElementById('ordersContainer').innerHTML = `
            <div class="alert alert-danger">
                ❌ Lỗi tải đơn hàng có sẵn: ${error.message}
            </div>
        `;
    }
}

// Display all orders
function displayAllOrders() {
    displayOrders(allOrders, 'all');
}

// Display orders function
function displayOrders(orders, type = 'all') {
    const container = document.getElementById('ordersContainer');
    
    if (orders.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                📦 ${type === 'available' ? 'Không có đơn hàng mới nào' : 'Chưa có đơn hàng nào'}
            </div>
        `;
        return;
    }

    let tableHTML = `
        <table class="orders-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Sản phẩm</th>
                    <th>Khách hàng</th>
                    <th>Số lượng</th>
                    <th>Giá tối đa</th>
                    <th>Địa chỉ giao</th>
                    <th>Trạng thái</th>
                    <th>Phí vận chuyển</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody>
    `;

    for (let order of orders) {
        const isMyOrder = order.transporter && order.transporter.toLowerCase() === userAddress.toLowerCase();
        
        // Điều kiện để báo giá: status = 0 (Pending) và chưa có transporter
        const canBid = order.status === 0 && (!order.transporter || order.transporter === '0x0000000000000000000000000000000000000000');
        
        // Điều kiện để cập nhật status: là đơn của mình và status = 3 (Approved) 
        const canUpdateStatus = isMyOrder && order.status === 3;
        
        // Điều kiện để xác nhận giao hàng: là đơn của mình, status = 3 (Approved) và deliveryStage = 2 (DeliveredFinal)
        const canConfirmDelivery = isMyOrder && order.status === 3 && order.deliveryStage === 2;

        const shippingFee = order.transportFee || order.shippingFee || 0;

        tableHTML += `
            <tr>
                <td>#${order.id}</td>
                <td>${order.productName}</td>
                <td>${truncateAddress(order.customer)}</td>
                <td>${order.quantity}</td>
                <td>${formatCurrency(order.maxUnitPrice)}</td>
                <td title="${order.deliveryAddress}">${order.deliveryAddress.substring(0, 30)}...</td>
                <td><span class="status-badge ${getStatusClass(order.status)}">${getStatusText(order.status)}</span></td>
                <td>${shippingFee > 0 ? formatCurrency(shippingFee) : 'Chưa có'}</td>
                <td>
                    <div class="order-actions">
                        ${canBid ? `<button class="btn btn-success" onclick="openPricingModal(${order.id})">💰 Báo giá</button>` : ''}
                        ${canUpdateStatus ? `<button class="btn btn-warning" onclick="openStatusModal(${order.id})">📝 Cập nhật</button>` : ''}
                        
                        <button class="btn btn-secondary" onclick="viewOrderDetails(${order.id})">👁️ Chi tiết</button>
                    </div>
                </td>
            </tr>
        `;
    }

    tableHTML += '</tbody></table>';
    container.innerHTML = tableHTML;
}

// Update dashboard statistics
function updateDashboard() {
    const myOrders = allOrders.filter(order => 
        order.transporter && order.transporter.toLowerCase() === userAddress.toLowerCase()
    );

    const activeOrders = myOrders.filter(order => order.status === 3); // Approved orders
    const completedOrders = myOrders.filter(order => order.status === 4); // Delivered orders
    const totalEarnings = myOrders.reduce((sum, order) => sum + (order.transportFee || 0), 0);

    document.getElementById('totalOrders').textContent = myOrders.length;
    document.getElementById('activeOrders').textContent = activeOrders.length;
    document.getElementById('completedOrders').textContent = completedOrders.length;
    document.getElementById('totalEarnings').textContent = totalEarnings;
}

// Open pricing modal - CHƯA ĐƯỢC SỬ DỤNG VÌ TRANSPORTER KHÔNG ĐƯỢC PHÉP TỰ BÁOGIÁ
// Theo contract, chỉ có manager mới có thể gọi approveOrder với transporter và transportFee
function openPricingModal(orderId) {
    const order = allOrders.find(o => o.id === orderId);
    if (!order) return;

    currentOrderId = orderId;
    
    // Populate order details
    document.getElementById('pricingOrderDetails').innerHTML = `
        <div class="detail-row">
            <span class="detail-label">ID đơn hàng:</span>
            <span class="detail-value">#${order.id}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Sản phẩm:</span>
            <span class="detail-value">${order.productName}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Số lượng:</span>
            <span class="detail-value">${order.quantity}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Giá tối đa/đơn vị:</span>
            <span class="detail-value">${formatCurrency(order.maxUnitPrice)}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Địa chỉ giao hàng:</span>
            <span class="detail-value">${order.deliveryAddress}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Khách hàng:</span>
            <span class="detail-value">${truncateAddress(order.customer)}</span>
        </div>
    `;

    // Calculate suggested price (example: 10% of total order value)
    const suggestedPrice = Math.floor(order.maxUnitPrice * order.quantity * 0.1);
    document.getElementById('suggestedPrice').value = suggestedPrice;
    document.getElementById('pricingNote').value = '';

    document.getElementById('pricingModal').classList.add('show');
}

// Submit pricing proposal - KHÔNG HOẠT ĐỘNG VÌ CONTRACT KHÔNG CÓ FUNCTION NÀY
async function submitPricing() {
    if (!contract || currentOrderId === null) return;

    try {
        const suggestedPrice = document.getElementById('suggestedPrice').value;
        const note = document.getElementById('pricingNote').value;

        if (!suggestedPrice || suggestedPrice <= 0) {
            showStatus('❌ Vui lòng nhập giá vận chuyển hợp lệ!', 'error');
            return;
        }

        showStatus('⏳ Đang gửi đề xuất giá...', 'info');

        // LƯU Ý: Contract không có function proposeShipping
        // Cần thêm function này vào contract hoặc thay đổi logic
        showStatus('❌ Chức năng báo giá chưa được triển khai trong contract!', 'error');
        
        closeModal('pricingModal');

    } catch (error) {
        console.error('Lỗi gửi đề xuất giá:', error);
        showStatus(`❌ Lỗi gửi đề xuất giá: ${error.message}`, 'error');
    }
}

// Open status update modal
function openStatusModal(orderId) {
    const order = allOrders.find(o => o.id === orderId);
    if (!order) return;

    currentOrderId = orderId;
    
    // Populate order details
    document.getElementById('statusOrderDetails').innerHTML = `
        <div class="detail-row">
            <span class="detail-label">ID đơn hàng:</span>
            <span class="detail-value">#${order.id}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Sản phẩm:</span>
            <span class="detail-value">${order.productName}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Trạng thái hiện tại:</span>
            <span class="detail-value">
                <span class="status-badge ${getStatusClass(order.status)}">${getStatusText(order.status)}</span>
            </span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Giai đoạn giao hàng:</span>
            <span class="detail-value">${getDeliveryStageText(order.deliveryStage)}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Địa chỉ giao hàng:</span>
            <span class="detail-value">${order.deliveryAddress}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Phí vận chuyển:</span>
            <span class="detail-value">${formatCurrency(order.transportFee || 0)}</span>
        </div>
    `;

    // Set appropriate delivery stage options
    const statusSelect = document.getElementById('newStatus');
    statusSelect.innerHTML = '';

    if (order.deliveryStage === 0) { // Preparing
        statusSelect.innerHTML = `
            <option value="1">📦 Đã lấy hàng</option>
        `;
    } else if (order.deliveryStage === 1) { // PickedUp
        statusSelect.innerHTML = `
            <option value="2">✅ Đã giao hàng</option>
        `;
    }

    document.getElementById('statusModal').classList.add('show');
}

// Update order delivery stage
async function updateOrderStatus() {
    if (!contract || currentOrderId === null) return;

    try {
        const newStage = parseInt(document.getElementById('newStatus').value);
        
        showStatus('⏳ Đang cập nhật trạng thái giao hàng...', 'info');

        // Sử dụng updateDeliveryStage thay vì updateShippingStatus
        const tx = await contract.updateDeliveryStage(currentOrderId, newStage);
        showStatus('⏳ Đang xử lý giao dịch...', 'info');

        await tx.wait();
        
        showStatus('✅ Đã cập nhật trạng thái giao hàng thành công!', 'success');
        closeModal('statusModal');

        // Refresh orders
        await loadAllOrders();

    } catch (error) {
        console.error('Lỗi cập nhật trạng thái:', error);
        showStatus(`❌ Lỗi cập nhật trạng thái: ${error.message}`, 'error');
    }
}

// Confirm delivery completion - CHỈ CUSTOMER MỚI CÓ THỂ XÁC NHẬN
async function confirmDelivery(orderId) {
    if (!contract) return;

    // Kiểm tra xem user có phải là customer không
    const order = allOrders.find(o => o.id === orderId);
    if (!order) return;

    if (order.customer.toLowerCase() !== userAddress.toLowerCase()) {
        showStatus('❌ Chỉ khách hàng mới có thể xác nhận nhận hàng!', 'error');
        return;
    }

    if (!confirm('🚚 Xác nhận đã nhận hàng thành công?\n\nLưu ý: Sau khi xác nhận, tiền sẽ được chuyển cho nhà cung cấp và người vận chuyển.')) {
        return;
    }

    try {
        showStatus('⏳ Đang xác nhận nhận hàng...', 'info');

        // Sử dụng confirmReceipt thay vì confirmDelivery
        const tx = await contract.confirmReceipt(orderId);
        showStatus('⏳ Đang xử lý giao dịch...', 'info');

        await tx.wait();
        
        showStatus('✅ Đã xác nhận nhận hàng thành công! Tiền đã được chuyển.', 'success');

        // Refresh orders and dashboard
        await loadAllOrders();

    } catch (error) {
        console.error('Lỗi xác nhận nhận hàng:', error);
        showStatus(`❌ Lỗi xác nhận nhận hàng: ${error.message}`, 'error');
    }
}

// View order details
function viewOrderDetails(orderId) {
    const order = allOrders.find(o => o.id === orderId);
    if (!order) return;

    const isMyOrder = order.transporter && order.transporter.toLowerCase() === userAddress.toLowerCase();
    const isCustomer = order.customer.toLowerCase() === userAddress.toLowerCase();
    
    alert(`
📦 CHI TIẾT ĐƠN HÀNG #${order.id}

🏷️ Sản phẩm: ${order.productName}
📊 Số lượng: ${order.quantity}
💰 Giá tối đa/đơn vị: ${formatCurrency(order.maxUnitPrice)}
🏠 Địa chỉ giao: ${order.deliveryAddress}

👤 Khách hàng: ${order.customer}
🏢 Nhà cung cấp: ${order.supplier}
🚛 Vận chuyển: ${order.transporter === '0x0000000000000000000000000000000000000000' ? 'Chưa có' : order.transporter}

📋 Trạng thái: ${getStatusText(order.status)}
🚚 Giai đoạn giao hàng: ${getDeliveryStageText(order.deliveryStage)}
💵 Phí vận chuyển: ${order.transportFee > 0 ? formatCurrency(order.transportFee) : 'Chưa có'}

${isMyOrder ? '✅ Đây là đơn hàng bạn vận chuyển' : ''}
${isCustomer ? '👤 Đây là đơn hàng của bạn' : ''}
    `);
}

// Helper function to get delivery stage text
function getDeliveryStageText(stage) {
    switch(stage) {
        case 0: return '📋 Đang chuẩn bị';
        case 1: return '📦 Đã lấy hàng';
        case 2: return '✅ Đã giao hàng';
        default: return 'Không xác định';
    }
}

// Close modal
function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
    currentOrderId = null;
}

// Auto-refresh orders every 30 seconds
setInterval(async () => {
    if (contract && userAddress) {
        try {
            await loadAllOrders();
        } catch (error) {
            console.error('Lỗi tự động làm mới:', error);
        }
    }
}, 30000);

// Handle clicks outside modal to close
document.addEventListener('click', function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            modal.classList.remove('show');
            currentOrderId = null;
        }
    });
});

// Handle Enter key in forms
document.addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        const activeModal = document.querySelector('.modal.show');
        if (activeModal) {
            if (activeModal.id === 'pricingModal') {
                submitPricing();
            } else if (activeModal.id === 'statusModal') {
                updateOrderStatus();
            }
        } else if (document.getElementById('loginSection').style.display !== 'none') {
            connectWallet();
        }
    }
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Set default mode
    selectMode('private');
    
    // Show initial status
    showStatus('🔌 Sẵn sàng kết nối với blockchain', 'info');
});
</script>
</body>
</html>
