<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng Qu·∫£n l√Ω V·∫≠n chuy·ªÉn</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .login-section {
            max-width: 500px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .account-info {
            display: none;
            align-items: center;
            justify-content: space-between;
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            color: white;
            margin-bottom: 20px;
        }

        .account-details {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .dashboard-content {
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .stat-card p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .orders-table th,
        .orders-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }

        .orders-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        .orders-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-preparing {
            background: #cce5ff;
            color: #004085;
        }

        .status-pickup {
            background: #e2e3ff;
            color: #383d41;
        }

        .status-delivering {
            background: #b3d9ff;
            color: #004085;
        }

        .status-delivered {
            background: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .order-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .order-actions .btn {
            padding: 8px 15px;
            font-size: 14px;
            margin: 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e1e5e9;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 8px;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }

        .alert-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }

        .order-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #e1e5e9;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: #555;
        }

        .detail-value {
            color: #333;
        }

        .connection-mode {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }

        .connection-mode h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .mode-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
        }

        .mode-btn:hover {
            background: #667eea;
            color: white;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .orders-table {
                font-size: 14px;
            }

            .orders-table th,
            .orders-table td {
                padding: 10px 8px;
            }

            .order-actions {
                flex-direction: column;
            }

            .order-actions .btn {
                width: 100%;
                margin-bottom: 5px;
            }

            .mode-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöö H·ªá th·ªëng Qu·∫£n l√Ω V·∫≠n chuy·ªÉn</h1>
            <p>Qu·∫£n l√Ω ƒë∆°n h√†ng v√† d·ªãch v·ª• v·∫≠n chuy·ªÉn</p>
        </div>

        <!-- Account Info -->
        <div class="account-info" id="accountInfo">
            <div class="account-details">
                <div>
                    <strong>üè† ƒê·ªãa ch·ªâ v√≠:</strong>
                    <span id="walletAddress">Ch∆∞a k·∫øt n·ªëi</span>
                </div>
                <div>
                    <strong>üìÑ Contract:</strong>
                    <span id="currentContract">Ch∆∞a thi·∫øt l·∫≠p</span>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="logout()">ƒêƒÉng xu·∫•t</button>
        </div>

        <!-- Login Section -->
        <div class="login-section" id="loginSection">
            <div class="card">
                <h2 style="text-align: center; margin-bottom: 25px; color: #333;">üîê ƒêƒÉng nh·∫≠p Transporter</h2>
                
                <!-- Connection Mode Selection -->
                <div class="connection-mode">
                    <h4>üîå Ch·ªçn ph∆∞∆°ng th·ª©c k·∫øt n·ªëi</h4>
                    <div class="mode-buttons">
                        <button class="mode-btn active" onclick="selectMode('private')">üîë Private Key</button>
                        <button class="mode-btn" onclick="selectMode('metamask')">ü¶ä MetaMask</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="rpcUrl">üåê RPC URL</label>
                    <input type="text" id="rpcUrl" class="form-control" placeholder="http://localhost:8545" value="http://localhost:8545">
                </div>

                <div class="form-group">
                    <label for="contractAddress">üìÑ ƒê·ªãa ch·ªâ Contract</label>
                    <input type="text" id="contractAddress" class="form-control" placeholder="0x...">
                </div>

                <div class="form-group" id="privateKeyGroup">
                    <label for="privateKey">üîë Private Key</label>
                    <input type="password" id="privateKey" class="form-control" placeholder="0x...">
                </div>

                <button class="btn" onclick="connectWallet()" style="width: 100%;">
                    <span id="connectButtonText">üöÄ K·∫øt n·ªëi v√≠</span>
                </button>

                <div id="walletStatus" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div class="dashboard-content" id="dashboardContent">
            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalOrders">0</h3>
                    <p>üì¶ T·ªïng ƒë∆°n h√†ng</p>
                </div>
                <div class="stat-card">
                    <h3 id="activeOrders">0</h3>
                    <p>üöõ ƒêang v·∫≠n chuy·ªÉn</p>
                </div>
                <div class="stat-card">
                    <h3 id="completedOrders">0</h3>
                    <p>‚úÖ ƒê√£ ho√†n th√†nh</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalEarnings">0</h3>
                    <p>üí∞ T·ªïng thu nh·∫≠p (Wei)</p>
                </div>
            </div>

            <!-- Orders Table -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>üì¶ Qu·∫£n l√Ω ƒë∆°n h√†ng</h3>
                    <div>
                        <button class="btn" onclick="loadAllOrders()">üîÑ L√†m m·ªõi</button>
                        <button class="btn btn-success" onclick="loadAvailableOrders()">üÜï T√¨m ƒë∆°n h√†ng m·ªõi</button>
                    </div>
                </div>
                
                <div id="ordersContainer">
                    <div class="loading">ƒêang t·∫£i ƒë∆°n h√†ng...</div>
                </div>
            </div>
        </div>

        <!-- Pricing Modal -->
        <div class="modal" id="pricingModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üí∞ ƒê·ªÅ xu·∫•t gi√° v·∫≠n chuy·ªÉn</h3>
                    <button class="close-btn" onclick="closeModal('pricingModal')">&times;</button>
                </div>

                <div class="order-details" id="pricingOrderDetails">
                    <!-- Order details will be populated here -->
                </div>

                <div class="form-group">
                    <label for="suggestedPrice">üíµ Gi√° ƒë·ªÅ xu·∫•t (Wei)</label>
                    <input type="number" id="suggestedPrice" class="form-control" placeholder="Nh·∫≠p gi√° v·∫≠n chuy·ªÉn" min="1">
                </div>

                <div class="form-group">
                    <label for="pricingNote">üìù Ghi ch√∫</label>
                    <textarea id="pricingNote" class="form-control" rows="3" placeholder="Ghi ch√∫ v·ªÅ d·ªãch v·ª• v·∫≠n chuy·ªÉn..."></textarea>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="closeModal('pricingModal')">H·ªßy</button>
                    <button class="btn" onclick="submitPricing()">üì§ G·ª≠i b√°o gi√°</button>
                </div>
            </div>
        </div>

        <!-- Status Update Modal -->
        <div class="modal" id="statusModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üìù C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng</h3>
                    <button class="close-btn" onclick="closeModal('statusModal')">&times;</button>
                </div>
                
                <div class="order-details" id="statusOrderDetails">
                    <!-- Order details will be populated here -->
                </div>

                <div class="form-group">
                    <label for="newStatus">Tr·∫°ng th√°i m·ªõi</label>
                    <select id="newStatus" class="form-control">
                        <option value="3">üöõ ƒêang giao h√†ng</option>
                        <option value="4">‚úÖ ƒê√£ giao h√†ng</option>
                    </select>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="closeModal('statusModal')">H·ªßy</button>
                    <button class="btn" onclick="updateOrderStatus()">üíæ C·∫≠p nh·∫≠t</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Contract ABI - Simplified version focusing on essential functions
        const contractABI = [
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			}
		],
		"name": "DeliveryConfirmed",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "enum SupplyChainSystem.DeliveryStage",
				"name": "stage",
				"type": "uint8"
			}
		],
		"name": "DeliveryUpdated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "ManagerAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "ManagerRemoved",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "supplier",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "transporter",
				"type": "address"
			}
		],
		"name": "OrderApproved",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "customer",
				"type": "address"
			}
		],
		"name": "OrderPlaced",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "supplier",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "unitPrice",
				"type": "uint256"
			}
		],
		"name": "ProductAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			}
		],
		"name": "Refunded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "target",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint8",
				"name": "rating",
				"type": "uint8"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "comment",
				"type": "string"
			}
		],
		"name": "ReviewSubmitted",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "TransporterAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "TransporterRemoved",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			}
		],
		"name": "acceptQuotation",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "addManager",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "unitPrice",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "stock",
				"type": "uint256"
			}
		],
		"name": "addProduct",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "addTransporter",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "unitPrice",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "transporter",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "transportFee",
				"type": "uint256"
			}
		],
		"name": "approveOrder",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			}
		],
		"name": "cancelOrder",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			}
		],
		"name": "confirmReceipt",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "customerToRequests",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "deliveries",
		"outputs": [
			{
				"internalType": "address",
				"name": "transporter",
				"type": "address"
			},
			{
				"internalType": "enum SupplyChainSystem.DeliveryStage",
				"name": "stage",
				"type": "uint8"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getAllProducts",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "name",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "unitPrice",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "stock",
						"type": "uint256"
					}
				],
				"internalType": "struct SupplyChainSystem.Product[]",
				"name": "",
				"type": "tuple[]"
			},
			{
				"internalType": "address[]",
				"name": "",
				"type": "address[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getAllRequests",
		"outputs": [
			{
				"components": [
					{
						"internalType": "uint256",
						"name": "id",
						"type": "uint256"
					},
					{
						"internalType": "address",
						"name": "customer",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "supplier",
						"type": "address"
					},
					{
						"internalType": "string",
						"name": "productName",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "quantity",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "maxUnitPrice",
						"type": "uint256"
					},
					{
						"internalType": "string",
						"name": "deliveryAddress",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "timestamp",
						"type": "uint256"
					},
					{
						"internalType": "enum SupplyChainSystem.RequestStatus",
						"name": "status",
						"type": "uint8"
					}
				],
				"internalType": "struct SupplyChainSystem.PurchaseRequest[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "customer",
				"type": "address"
			}
		],
		"name": "getCustomerRequests",
		"outputs": [
			{
				"internalType": "uint256[]",
				"name": "",
				"type": "uint256[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			}
		],
		"name": "getDelivery",
		"outputs": [
			{
				"components": [
					{
						"internalType": "address",
						"name": "transporter",
						"type": "address"
					},
					{
						"internalType": "enum SupplyChainSystem.DeliveryStage",
						"name": "stage",
						"type": "uint8"
					}
				],
				"internalType": "struct SupplyChainSystem.DeliveryInfo",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			}
		],
		"name": "getPayment",
		"outputs": [
			{
				"components": [
					{
						"internalType": "address",
						"name": "customer",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "supplier",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "transporter",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "supplierAmount",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "transportFee",
						"type": "uint256"
					},
					{
						"internalType": "bool",
						"name": "settled",
						"type": "bool"
					},
					{
						"internalType": "bool",
						"name": "refunded",
						"type": "bool"
					}
				],
				"internalType": "struct SupplyChainSystem.Payment",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "supplier",
				"type": "address"
			}
		],
		"name": "getSupplierProducts",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "name",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "unitPrice",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "stock",
						"type": "uint256"
					}
				],
				"internalType": "struct SupplyChainSystem.Product[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "supplier",
				"type": "address"
			}
		],
		"name": "getSupplierReviews",
		"outputs": [
			{
				"components": [
					{
						"internalType": "uint8",
						"name": "rating",
						"type": "uint8"
					},
					{
						"internalType": "string",
						"name": "comment",
						"type": "string"
					}
				],
				"internalType": "struct SupplyChainSystem.Review[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "transporter",
				"type": "address"
			}
		],
		"name": "getTransporterReviews",
		"outputs": [
			{
				"components": [
					{
						"internalType": "uint8",
						"name": "rating",
						"type": "uint8"
					},
					{
						"internalType": "string",
						"name": "comment",
						"type": "string"
					}
				],
				"internalType": "struct SupplyChainSystem.Review[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "isManager",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "isTransporter",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			},
			{
				"internalType": "uint8",
				"name": "rating",
				"type": "uint8"
			},
			{
				"internalType": "string",
				"name": "comment",
				"type": "string"
			}
		],
		"name": "leaveReview",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "offeredPrices",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "payments",
		"outputs": [
			{
				"internalType": "address",
				"name": "customer",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "supplier",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "transporter",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "supplierAmount",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "transportFee",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "settled",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "refunded",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "supplier",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "productName",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "quantity",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "maxUnitPrice",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "deliveryAddress",
				"type": "string"
			}
		],
		"name": "placeOrder",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			}
		],
		"name": "processRefund",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "removeManager",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "removeTransporter",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "requests",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "customer",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "supplier",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "productName",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "quantity",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "maxUnitPrice",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "deliveryAddress",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			},
			{
				"internalType": "enum SupplyChainSystem.RequestStatus",
				"name": "status",
				"type": "uint8"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "unitPrice",
				"type": "uint256"
			}
		],
		"name": "sendQuotation",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "supplierProducts",
		"outputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "unitPrice",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "stock",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "supplierReviews",
		"outputs": [
			{
				"internalType": "uint8",
				"name": "rating",
				"type": "uint8"
			},
			{
				"internalType": "string",
				"name": "comment",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "suppliers",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "transporterReviews",
		"outputs": [
			{
				"internalType": "uint8",
				"name": "rating",
				"type": "uint8"
			},
			{
				"internalType": "string",
				"name": "comment",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			},
			{
				"internalType": "enum SupplyChainSystem.DeliveryStage",
				"name": "stage",
				"type": "uint8"
			}
		],
		"name": "updateDeliveryStage",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	}
];

        // Global variables
        let provider = null;
        let signer = null;
        let contract = null;
        let userAddress = '';
        let allOrders = [];
        let currentOrderId = null;
        let connectionMode = 'private'; // 'private' or 'metamask'

        // Status mappings
        const statusMap = {
            0: { text: 'Ch·ªù x·ª≠ l√Ω', class: 'status-pending' },
            1: { text: 'ƒê√£ b√°o gi√°', class: 'status-preparing' },
            2: { text: 'ƒê√£ ch·∫•p nh·∫≠n', class: 'status-pickup' },
            3: { text: 'ƒêang giao h√†ng', class: 'status-delivering' },
            4: { text: 'ƒê√£ giao h√†ng', class: 'status-delivered' },
            5: { text: 'ƒê√£ h·ªßy', class: 'status-cancelled' }
        };

        // Utility functions
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('walletStatus');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + ' Wei';
        }

        function truncateAddress(address) {
            if (!address) return '';
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        }

        function getStatusText(status) {
            return statusMap[status]?.text || 'Kh√¥ng r√µ';
        }

        function getStatusClass(status) {
            return statusMap[status]?.class || 'status-pending';
        }

        // Select connection mode
        function selectMode(mode) {
            connectionMode = mode;
            
            // Update UI
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const privateKeyGroup = document.getElementById('privateKeyGroup');
            const connectButtonText = document.getElementById('connectButtonText');
            
            if (mode === 'metamask') {
                privateKeyGroup.style.display = 'none';
                connectButtonText.textContent = 'ü¶ä K·∫øt n·ªëi MetaMask';
            } else {
                privateKeyGroup.style.display = 'block';
                connectButtonText.textContent = 'üöÄ K·∫øt n·ªëi v√≠';
            }
        }

        // Connect wallet function
        async function connectWallet() {
            try {
                const rpcUrl = document.getElementById('rpcUrl').value;
                const contractAddress = document.getElementById('contractAddress').value;

                if (!rpcUrl || !contractAddress) {
                    showStatus('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß RPC URL v√† ƒë·ªãa ch·ªâ Contract!', 'error');
                    return;
                }

                showStatus('‚è≥ ƒêang k·∫øt n·ªëi...', 'info');

                if (connectionMode === 'metamask') {
                    // Connect with MetaMask
                    if (typeof window.ethereum === 'undefined') {
                        showStatus('‚ùå Vui l√≤ng c√†i ƒë·∫∑t MetaMask!', 'error');
                        return;
                    }

                    // Request account access
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    
                    // Create provider and signer
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                    userAddress = await signer.getAddress();

                } else {
                    // Connect with private key
                    const privateKey = document.getElementById('privateKey').value;
                    
                    if (!privateKey) {
                        showStatus('Vui l√≤ng nh·∫≠p Private Key!', 'error');
                        return;
                    }

                    // Connect to provider
                    provider = new ethers.JsonRpcProvider(rpcUrl);
                    
                    // Create wallet from private key
                    signer = new ethers.Wallet(privateKey, provider);
                    userAddress = await signer.getAddress();
                }
                
                // Create contract instance
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                
                // Check balance
                const balance = await provider.getBalance(userAddress);
                
                // Update UI
                document.getElementById('walletAddress').textContent = truncateAddress(userAddress);
                document.getElementById('currentContract').textContent = truncateAddress(contractAddress);
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                document.getElementById('accountInfo').style.display = 'flex';
                
                showStatus(`‚úÖ K·∫øt n·ªëi th√†nh c√¥ng!<br>
                           üìç ƒê·ªãa ch·ªâ: ${userAddress}<br>
                           üí∞ S·ªë d∆∞: ${ethers.formatEther(balance)} ETH`, 'success');
                
                // Load initial data
                await loadAllOrders();
                
            } catch (error) {
                console.error('L·ªói k·∫øt n·ªëi:', error);
                showStatus(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
            }
        }

        // Logout function
        function logout() {
            provider = null;
            signer = null;
            contract = null;
            userAddress = '';
            allOrders = [];
            
            // Clear inputs
            if (connectionMode === 'private') {
                document.getElementById('privateKey').value = '';
            }
            
            // Update UI
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('dashboardContent').style.display = 'none';
            document.getElementById('accountInfo').style.display = 'none';
            
            showStatus('‚úÖ ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng', 'success');
        }

       // Load all orders
async function loadAllOrders() {
    if (!contract) return;

    try {
        document.getElementById('ordersContainer').innerHTML = '<div class="loading">ƒêang t·∫£i ƒë∆°n h√†ng...</div>';

        // S·ª≠ d·ª•ng getAllRequests() thay v√¨ requestCounter()
        const allRequests = await contract.getAllRequests();
        allOrders = [];

        for (let order of allRequests) {
            // L·∫•y th√¥ng tin delivery v√† payment ri√™ng bi·ªát
            const deliveryInfo = await contract.getDelivery(order.id);
            const paymentInfo = await contract.getPayment(order.id);

            allOrders.push({
                id: Number(order.id),
                customer: order.customer,
                supplier: order.supplier,
                productName: order.productName,
                quantity: Number(order.quantity),
                maxUnitPrice: Number(order.maxUnitPrice),
                deliveryAddress: order.deliveryAddress,
                status: Number(order.status),
                timestamp: Number(order.timestamp),
                // Th√¥ng tin t·ª´ delivery
                transporter: deliveryInfo.transporter,
                deliveryStage: Number(deliveryInfo.stage),
                // Th√¥ng tin t·ª´ payment
                supplierAmount: Number(paymentInfo.supplierAmount),
                transportFee: Number(paymentInfo.transportFee),
                settled: paymentInfo.settled,
                refunded: paymentInfo.refunded
            });
        }

        displayAllOrders();
        updateDashboard();

    } catch (error) {
        console.error('L·ªói t·∫£i ƒë∆°n h√†ng:', error);
        document.getElementById('ordersContainer').innerHTML = `
            <div class="alert alert-danger">
                ‚ùå L·ªói t·∫£i ƒë∆°n h√†ng: ${error.message}
            </div>
        `;
    }
}

// Load only available orders
async function loadAvailableOrders() {
    if (!contract) return;

    try {
        document.getElementById('ordersContainer').innerHTML = '<div class="loading">ƒêang t·∫£i ƒë∆°n h√†ng c√≥ s·∫µn...</div>';

        // S·ª≠ d·ª•ng getAllRequests() thay v√¨ requestCounter()
        const allRequests = await contract.getAllRequests();
        const availableOrders = [];

        for (let order of allRequests) {
            const deliveryInfo = await contract.getDelivery(order.id);
            
            // Ch·ªâ hi·ªÉn th·ªã ƒë∆°n h√†ng ch∆∞a c√≥ transporter ho·∫∑c ƒëang ch·ªù b√°o gi√°
            if (Number(order.status) === 0 && 
                (deliveryInfo.transporter === '0x0000000000000000000000000000000000000000' || 
                 deliveryInfo.transporter.toLowerCase() === userAddress.toLowerCase())) {
                
                const paymentInfo = await contract.getPayment(order.id);
                
                availableOrders.push({
                    id: Number(order.id),
                    customer: order.customer,
                    supplier: order.supplier,
                    productName: order.productName,
                    quantity: Number(order.quantity),
                    maxUnitPrice: Number(order.maxUnitPrice),
                    deliveryAddress: order.deliveryAddress,
                    status: Number(order.status),
                    transporter: deliveryInfo.transporter,
                    shippingFee: Number(paymentInfo.transportFee)
                });
            }
        }

        displayOrders(availableOrders, 'available');

    } catch (error) {
        console.error('L·ªói t·∫£i ƒë∆°n h√†ng c√≥ s·∫µn:', error);
        document.getElementById('ordersContainer').innerHTML = `
            <div class="alert alert-danger">
                ‚ùå L·ªói t·∫£i ƒë∆°n h√†ng c√≥ s·∫µn: ${error.message}
            </div>
        `;
    }
}

// Display all orders
function displayAllOrders() {
    displayOrders(allOrders, 'all');
}

// Display orders function
function displayOrders(orders, type = 'all') {
    const container = document.getElementById('ordersContainer');
    
    if (orders.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                üì¶ ${type === 'available' ? 'Kh√¥ng c√≥ ƒë∆°n h√†ng m·ªõi n√†o' : 'Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o'}
            </div>
        `;
        return;
    }

    let tableHTML = `
        <table class="orders-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>S·∫£n ph·∫©m</th>
                    <th>Kh√°ch h√†ng</th>
                    <th>S·ªë l∆∞·ª£ng</th>
                    <th>Gi√° t·ªëi ƒëa</th>
                    <th>ƒê·ªãa ch·ªâ giao</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Ph√≠ v·∫≠n chuy·ªÉn</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody>
    `;

    for (let order of orders) {
        const isMyOrder = order.transporter && order.transporter.toLowerCase() === userAddress.toLowerCase();
        
        // ƒêi·ªÅu ki·ªán ƒë·ªÉ b√°o gi√°: status = 0 (Pending) v√† ch∆∞a c√≥ transporter
        const canBid = order.status === 0 && (!order.transporter || order.transporter === '0x0000000000000000000000000000000000000000');
        
        // ƒêi·ªÅu ki·ªán ƒë·ªÉ c·∫≠p nh·∫≠t status: l√† ƒë∆°n c·ªßa m√¨nh v√† status = 3 (Approved) 
        const canUpdateStatus = isMyOrder && order.status === 3;
        
        // ƒêi·ªÅu ki·ªán ƒë·ªÉ x√°c nh·∫≠n giao h√†ng: l√† ƒë∆°n c·ªßa m√¨nh, status = 3 (Approved) v√† deliveryStage = 2 (DeliveredFinal)
        const canConfirmDelivery = isMyOrder && order.status === 3 && order.deliveryStage === 2;

        const shippingFee = order.transportFee || order.shippingFee || 0;

        tableHTML += `
            <tr>
                <td>#${order.id}</td>
                <td>${order.productName}</td>
                <td>${truncateAddress(order.customer)}</td>
                <td>${order.quantity}</td>
                <td>${formatCurrency(order.maxUnitPrice)}</td>
                <td title="${order.deliveryAddress}">${order.deliveryAddress.substring(0, 30)}...</td>
                <td><span class="status-badge ${getStatusClass(order.status)}">${getStatusText(order.status)}</span></td>
                <td>${shippingFee > 0 ? formatCurrency(shippingFee) : 'Ch∆∞a c√≥'}</td>
                <td>
                    <div class="order-actions">
                        ${canBid ? `<button class="btn btn-success" onclick="openPricingModal(${order.id})">üí∞ B√°o gi√°</button>` : ''}
                        ${canUpdateStatus ? `<button class="btn btn-warning" onclick="openStatusModal(${order.id})">üìù C·∫≠p nh·∫≠t</button>` : ''}
                        
                        <button class="btn btn-secondary" onclick="viewOrderDetails(${order.id})">üëÅÔ∏è Chi ti·∫øt</button>
                    </div>
                </td>
            </tr>
        `;
    }

    tableHTML += '</tbody></table>';
    container.innerHTML = tableHTML;
}

// Update dashboard statistics
function updateDashboard() {
    const myOrders = allOrders.filter(order => 
        order.transporter && order.transporter.toLowerCase() === userAddress.toLowerCase()
    );

    const activeOrders = myOrders.filter(order => order.status === 3); // Approved orders
    const completedOrders = myOrders.filter(order => order.status === 4); // Delivered orders
    const totalEarnings = myOrders.reduce((sum, order) => sum + (order.transportFee || 0), 0);

    document.getElementById('totalOrders').textContent = myOrders.length;
    document.getElementById('activeOrders').textContent = activeOrders.length;
    document.getElementById('completedOrders').textContent = completedOrders.length;
    document.getElementById('totalEarnings').textContent = totalEarnings;
}

// Open pricing modal - CH∆ØA ƒê∆Ø·ª¢C S·ª¨ D·ª§NG V√å TRANSPORTER KH√îNG ƒê∆Ø·ª¢C PH√âP T·ª∞ B√ÅOGI√Å
// Theo contract, ch·ªâ c√≥ manager m·ªõi c√≥ th·ªÉ g·ªçi approveOrder v·ªõi transporter v√† transportFee
function openPricingModal(orderId) {
    const order = allOrders.find(o => o.id === orderId);
    if (!order) return;

    currentOrderId = orderId;
    
    // Populate order details
    document.getElementById('pricingOrderDetails').innerHTML = `
        <div class="detail-row">
            <span class="detail-label">ID ƒë∆°n h√†ng:</span>
            <span class="detail-value">#${order.id}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">S·∫£n ph·∫©m:</span>
            <span class="detail-value">${order.productName}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">S·ªë l∆∞·ª£ng:</span>
            <span class="detail-value">${order.quantity}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Gi√° t·ªëi ƒëa/ƒë∆°n v·ªã:</span>
            <span class="detail-value">${formatCurrency(order.maxUnitPrice)}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">ƒê·ªãa ch·ªâ giao h√†ng:</span>
            <span class="detail-value">${order.deliveryAddress}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Kh√°ch h√†ng:</span>
            <span class="detail-value">${truncateAddress(order.customer)}</span>
        </div>
    `;

    // Calculate suggested price (example: 10% of total order value)
    const suggestedPrice = Math.floor(order.maxUnitPrice * order.quantity * 0.1);
    document.getElementById('suggestedPrice').value = suggestedPrice;
    document.getElementById('pricingNote').value = '';

    document.getElementById('pricingModal').classList.add('show');
}

// Submit pricing proposal - KH√îNG HO·∫†T ƒê·ªòNG V√å CONTRACT KH√îNG C√ì FUNCTION N√ÄY
async function submitPricing() {
    if (!contract || currentOrderId === null) return;

    try {
        const suggestedPrice = document.getElementById('suggestedPrice').value;
        const note = document.getElementById('pricingNote').value;

        if (!suggestedPrice || suggestedPrice <= 0) {
            showStatus('‚ùå Vui l√≤ng nh·∫≠p gi√° v·∫≠n chuy·ªÉn h·ª£p l·ªá!', 'error');
            return;
        }

        showStatus('‚è≥ ƒêang g·ª≠i ƒë·ªÅ xu·∫•t gi√°...', 'info');

        // L∆ØU √ù: Contract kh√¥ng c√≥ function proposeShipping
        // C·∫ßn th√™m function n√†y v√†o contract ho·∫∑c thay ƒë·ªïi logic
        showStatus('‚ùå Ch·ª©c nƒÉng b√°o gi√° ch∆∞a ƒë∆∞·ª£c tri·ªÉn khai trong contract!', 'error');
        
        closeModal('pricingModal');

    } catch (error) {
        console.error('L·ªói g·ª≠i ƒë·ªÅ xu·∫•t gi√°:', error);
        showStatus(`‚ùå L·ªói g·ª≠i ƒë·ªÅ xu·∫•t gi√°: ${error.message}`, 'error');
    }
}

// Open status update modal
function openStatusModal(orderId) {
    const order = allOrders.find(o => o.id === orderId);
    if (!order) return;

    currentOrderId = orderId;
    
    // Populate order details
    document.getElementById('statusOrderDetails').innerHTML = `
        <div class="detail-row">
            <span class="detail-label">ID ƒë∆°n h√†ng:</span>
            <span class="detail-value">#${order.id}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">S·∫£n ph·∫©m:</span>
            <span class="detail-value">${order.productName}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Tr·∫°ng th√°i hi·ªán t·∫°i:</span>
            <span class="detail-value">
                <span class="status-badge ${getStatusClass(order.status)}">${getStatusText(order.status)}</span>
            </span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Giai ƒëo·∫°n giao h√†ng:</span>
            <span class="detail-value">${getDeliveryStageText(order.deliveryStage)}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">ƒê·ªãa ch·ªâ giao h√†ng:</span>
            <span class="detail-value">${order.deliveryAddress}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Ph√≠ v·∫≠n chuy·ªÉn:</span>
            <span class="detail-value">${formatCurrency(order.transportFee || 0)}</span>
        </div>
    `;

    // Set appropriate delivery stage options
    const statusSelect = document.getElementById('newStatus');
    statusSelect.innerHTML = '';

    if (order.deliveryStage === 0) { // Preparing
        statusSelect.innerHTML = `
            <option value="1">üì¶ ƒê√£ l·∫•y h√†ng</option>
        `;
    } else if (order.deliveryStage === 1) { // PickedUp
        statusSelect.innerHTML = `
            <option value="2">‚úÖ ƒê√£ giao h√†ng</option>
        `;
    }

    document.getElementById('statusModal').classList.add('show');
}

// Update order delivery stage
async function updateOrderStatus() {
    if (!contract || currentOrderId === null) return;

    try {
        const newStage = parseInt(document.getElementById('newStatus').value);
        
        showStatus('‚è≥ ƒêang c·∫≠p nh·∫≠t tr·∫°ng th√°i giao h√†ng...', 'info');

        // S·ª≠ d·ª•ng updateDeliveryStage thay v√¨ updateShippingStatus
        const tx = await contract.updateDeliveryStage(currentOrderId, newStage);
        showStatus('‚è≥ ƒêang x·ª≠ l√Ω giao d·ªãch...', 'info');

        await tx.wait();
        
        showStatus('‚úÖ ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i giao h√†ng th√†nh c√¥ng!', 'success');
        closeModal('statusModal');

        // Refresh orders
        await loadAllOrders();

    } catch (error) {
        console.error('L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i:', error);
        showStatus(`‚ùå L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i: ${error.message}`, 'error');
    }
}

// Confirm delivery completion - CH·ªà CUSTOMER M·ªöI C√ì TH·ªÇ X√ÅC NH·∫¨N
async function confirmDelivery(orderId) {
    if (!contract) return;

    // Ki·ªÉm tra xem user c√≥ ph·∫£i l√† customer kh√¥ng
    const order = allOrders.find(o => o.id === orderId);
    if (!order) return;

    if (order.customer.toLowerCase() !== userAddress.toLowerCase()) {
        showStatus('‚ùå Ch·ªâ kh√°ch h√†ng m·ªõi c√≥ th·ªÉ x√°c nh·∫≠n nh·∫≠n h√†ng!', 'error');
        return;
    }

    if (!confirm('üöö X√°c nh·∫≠n ƒë√£ nh·∫≠n h√†ng th√†nh c√¥ng?\n\nL∆∞u √Ω: Sau khi x√°c nh·∫≠n, ti·ªÅn s·∫Ω ƒë∆∞·ª£c chuy·ªÉn cho nh√† cung c·∫•p v√† ng∆∞·ªùi v·∫≠n chuy·ªÉn.')) {
        return;
    }

    try {
        showStatus('‚è≥ ƒêang x√°c nh·∫≠n nh·∫≠n h√†ng...', 'info');

        // S·ª≠ d·ª•ng confirmReceipt thay v√¨ confirmDelivery
        const tx = await contract.confirmReceipt(orderId);
        showStatus('‚è≥ ƒêang x·ª≠ l√Ω giao d·ªãch...', 'info');

        await tx.wait();
        
        showStatus('‚úÖ ƒê√£ x√°c nh·∫≠n nh·∫≠n h√†ng th√†nh c√¥ng! Ti·ªÅn ƒë√£ ƒë∆∞·ª£c chuy·ªÉn.', 'success');

        // Refresh orders and dashboard
        await loadAllOrders();

    } catch (error) {
        console.error('L·ªói x√°c nh·∫≠n nh·∫≠n h√†ng:', error);
        showStatus(`‚ùå L·ªói x√°c nh·∫≠n nh·∫≠n h√†ng: ${error.message}`, 'error');
    }
}

// View order details
function viewOrderDetails(orderId) {
    const order = allOrders.find(o => o.id === orderId);
    if (!order) return;

    const isMyOrder = order.transporter && order.transporter.toLowerCase() === userAddress.toLowerCase();
    const isCustomer = order.customer.toLowerCase() === userAddress.toLowerCase();
    
    alert(`
üì¶ CHI TI·∫æT ƒê∆†N H√ÄNG #${order.id}

üè∑Ô∏è S·∫£n ph·∫©m: ${order.productName}
üìä S·ªë l∆∞·ª£ng: ${order.quantity}
üí∞ Gi√° t·ªëi ƒëa/ƒë∆°n v·ªã: ${formatCurrency(order.maxUnitPrice)}
üè† ƒê·ªãa ch·ªâ giao: ${order.deliveryAddress}

üë§ Kh√°ch h√†ng: ${order.customer}
üè¢ Nh√† cung c·∫•p: ${order.supplier}
üöõ V·∫≠n chuy·ªÉn: ${order.transporter === '0x0000000000000000000000000000000000000000' ? 'Ch∆∞a c√≥' : order.transporter}

üìã Tr·∫°ng th√°i: ${getStatusText(order.status)}
üöö Giai ƒëo·∫°n giao h√†ng: ${getDeliveryStageText(order.deliveryStage)}
üíµ Ph√≠ v·∫≠n chuy·ªÉn: ${order.transportFee > 0 ? formatCurrency(order.transportFee) : 'Ch∆∞a c√≥'}

${isMyOrder ? '‚úÖ ƒê√¢y l√† ƒë∆°n h√†ng b·∫°n v·∫≠n chuy·ªÉn' : ''}
${isCustomer ? 'üë§ ƒê√¢y l√† ƒë∆°n h√†ng c·ªßa b·∫°n' : ''}
    `);
}

// Helper function to get delivery stage text
function getDeliveryStageText(stage) {
    switch(stage) {
        case 0: return 'üìã ƒêang chu·∫©n b·ªã';
        case 1: return 'üì¶ ƒê√£ l·∫•y h√†ng';
        case 2: return '‚úÖ ƒê√£ giao h√†ng';
        default: return 'Kh√¥ng x√°c ƒë·ªãnh';
    }
}

// Close modal
function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
    currentOrderId = null;
}

// Auto-refresh orders every 30 seconds
setInterval(async () => {
    if (contract && userAddress) {
        try {
            await loadAllOrders();
        } catch (error) {
            console.error('L·ªói t·ª± ƒë·ªông l√†m m·ªõi:', error);
        }
    }
}, 30000);

// Handle clicks outside modal to close
document.addEventListener('click', function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            modal.classList.remove('show');
            currentOrderId = null;
        }
    });
});

// Handle Enter key in forms
document.addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        const activeModal = document.querySelector('.modal.show');
        if (activeModal) {
            if (activeModal.id === 'pricingModal') {
                submitPricing();
            } else if (activeModal.id === 'statusModal') {
                updateOrderStatus();
            }
        } else if (document.getElementById('loginSection').style.display !== 'none') {
            connectWallet();
        }
    }
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Set default mode
    selectMode('private');
    
    // Show initial status
    showStatus('üîå S·∫µn s√†ng k·∫øt n·ªëi v·ªõi blockchain', 'info');
});
</script>
</body>
</html>
